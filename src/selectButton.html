<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline'; script-src * 'self' 'unsafe-inline'">
    <meta http-equiv="X-Content-Security-Policy" content="default-src * 'self' 'unsafe-inline'; script-src * 'self' 'unsafe-inline'">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Makrotastatur Programmier-GUI</title>

    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <!--<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>-->

    <link rel="stylesheet" href="btn-arrows.css">
  </head>

  <body>
    <main class="main pt-2 px-1 m-0 mb-2 p-md-3 m-md-3">
      <button class="float-left btn-arrow-left mx-3 btn btn-dark" onclick="history.back()">Zurück</button>
      <h3 class="text-right">Makrotastatur - Taster auswählen</h3>
      <hr></hr>

      <div class="container-fluid h-100 m-0 p-0 row">
        <div class="order-1 col-12 col-md-4 col-lg-3 mb-2 mb-md-0 pr-0 pr-md-3 pl-0" style="">
          <div class="w-100 p-3" style="border: 1px solid gray;">
            <h5>Technische Informationen</h5>
            <hr class="p-0 mt-0"></hr>

            <p>Hardware-revision: <b>1</b></p>
            <p>Softwareversion:  <b>1.0</b></p>
            <p>EEPROM-Speicher (bytes): <b>1024</b></p>
          </div>
        </div>

        <div id="programListDiv" class="col-6 col-md-4 col-lg-5 order-3 px-0" style="border: 1px solid gray;">
          <div class="w-100 h-100 row m-0">
            <table id="programList" class='w-100 text-center'>
              <tr>
                <th class="p-1" style="border-bottom: 1px solid black; border-right: 1px solid black; width: 20%">
                  Befehl
                </th>
                <th class="p-1" style="border-bottom: 1px solid black;">
                  Wert
                </th>
              </tr>
            </table>
            <button onclick="location.href='programButton.html'" class="w-100 rounded-0 mt-auto btn btn-success">Bearbeiten</button>
          </div>
        </div>

        <div id="buttonSelectList" class="sticky-top col-6 col-md-4 order-2 pl-0 pr-1 pr-sm-3 btn-group-vertical align-self-start">
          <div class="btn-group mb-1">
            <button id="button0" onclick="loadButton(0)" class="btn btn-dark mr-1">Taster 1</button>
            <button id="button1" onclick="loadButton(1)" class="btn btn-dark     ">Taster 2</button>
          </div>
          <div class="btn-group mb-1">
            <button id="button2" onclick="loadButton(2)" class="btn btn-dark mr-1">Taster 3</button>
            <button id="button3" onclick="loadButton(3)" class="btn btn-dark     ">Taster 4</button>
          </div>
          <div class="btn-group">
            <button id="button4" onclick="loadButton(4)" class="btn btn-dark mr-1">Taster 5</button>
            <button id="button5" onclick="loadButton(5)" class="btn btn-dark     ">Taster 6</button>
          </div>
        </div>
      </div>

      <script>
        buttonID = -1;

        function loadButton(btnID){
          var button = $("#button"+buttonID);
          if (button.hasClass("disabled")) {
            // Prevent double clicks
            return;
          }

          buttonID = btnID;
          $("#programList .cmndTr").remove();

          if (!window.Bridge.isPortOpen()) {
            var devicePath = localStorage.getItem('devicePath');
            if (devicePath == undefined || devicePath == null) {
              console.error("Oh oh! Sieht so aus als würde devicePath nichts im localStorage gesetzt sein.");
              return;
            }
            console.log("Stelle Verbindung mit '"+devicePath+"' her.");

            window.Bridge.setCOMPath(devicePath);


            window.Bridge.onOpen = function() {
              console.log("Verbindung zu Gerät '" + devicePath + "' geöffnet!");
              window.Bridge.sendMessage("GETBUTTONS");
            };

            window.Bridge.onDataReceive = function(msg){
              console.log("<tastatur>: " + msg);

              msg = msg.split(";", 3);
              buttonid = msg[0];
              cmnd_str = msg[1];
              value = msg[2];
              console.log(buttonID + "=" + buttonid + " " + cmnd_str + " " + value);

              if (buttonid == buttonID) {
                console.log("Befehl erkannt. '" + cmnd_str + "': '" + value + "'");

                var html_tablerow = `
                    <tr command="`+cmnd_str+`" style="width: 75%; border-top: 1px solid gray;" class='cmndTr p-0 pl-2 pr-2 pt-2 m-0'>
                      <td id="commandlabel" class='m-0 p-1' style="border-right: 1px solid black;">
                        `+cmnd_str+`
                      </td>
                      <td id="value" class="p-1">
                        ` + value +`
                      </td>
                    </tr>`;
                $("#programList").append(html_tablerow);
              }
            }

            window.Bridge.openSerialConnection();
          } else {
            window.Bridge.sendMessage("GETBUTTONS");
          }

          // Remove class from every other button
          $("#buttonSelectList .btn").each(function(){
            $(this).removeClass("disabled");
          });

          button.addClass("disabled");
          window.scrollTo({ left: 0, top: document.body.scrollHeight, behavior: "smooth" });
        }

        function addCommand(commandid) {
          html_tablerow = `
              <tr commandid="<CMNDID>" style="width: 75%; border-top: 1px solid gray;" class='p-0 pl-2 pr-2 pt-2 m-0'>
                <td id="commandlabel" class='m-0 p-0' style="border-right: 1px solid black;">
                  <img src="imgs/movable.png" alt="::" style="max-width: 20px; filter: opacity(50%);" class="m-0 p-0 d-inline-block float-left"></img> <COMMAND>
                </td>
                <td id="value">
                  <VALUE>
                </td>
              </tr>`;

          if (commandid == 1) {
            html_tablerow = html_tablerow.replace("<COMMAND>", "String");
            html_tablerow = html_tablerow.replace("<VALUE>",
                                    `<!-- pattern='[\\w,.!?+\\-#*\\s]+' -->
                                     <input name="string" class='p-1 m-0 mt-2 mx-2 form-control d-inline-block' type='text' wrap='off' pattern='[\\w,.!?+\\-#*\\s]+' style='max-width:95%; width:95%;'></input>
                                     <p class='text-muted text-right mr-3 pb-0 mb-0' style='font-size: 80%;'>do not use special characters except punctuation marks</p>
            `);
          } else if (commandid == 2) {
            html_tablerow = html_tablerow.replace("<COMMAND>", "Delay");
            html_tablerow = html_tablerow.replace("<VALUE>",
                                    `<input name="time" class="p-1 my-3 mx-2 form-control d-inline-block" min="0" style="max-width: 95%; width: 95%;" max="65536" type="number"></input>
            `);
          } else if (commandid == 3) {
            html_tablerow = html_tablerow.replace("<COMMAND>", "Mod Key Press");
          } else if (commandid == 4) {
            html_tablerow = html_tablerow.replace("<COMMAND>", "Mod Key Release");
          } else {
            return false;
          }

          if (commandid == 3 || commandid == 4) {
            html_tablerow = html_tablerow.replace("<VALUE>",`
              <select class="form-control p-0 my-3 mx-2 d-inline-block selectList" style="max-width: 95%; width: 95%;">
                <option>128 - LEFT CTRL</option>
                <option>129 - LEFT SHIFT</option>
                <option>130 - LEFT ALT</option>
                <option>131 - LEFT GUI</option>
                <option>132 - RIGHT CTRL</option>
                <option>133 - RIGHT SHIFT</option>
                <option>134 - RIGHT ALT</option>
                <option>135 - RIGHT GUI</option>
                <option>176 - RETURN</option>
                <option>177 - ESC</option>
                <option>178 - BACKSPACE</option>
                <option>179 - TAB</option>
                <option>215 - RIGHT ARROW</option>
                <option>216 - LEFT ARROW</option>
                <option>217 - DOWN ARROW</option>
                <option>218 - UP ARROW</option>
                <option>209 - INSERT</option>
                <option>212 - DELETE</option>
                <option>211 - PAGE UP</option>
                <option>214 - PAGE DOWN</option>
                <option>210 - HOME</option>
                <option>213 - END</option>
                <option>193 - CAPS LOCK</option>
                <option>194 - F1</option>
                <option>195 - F2</option>
                <option>196 - F3</option>
                <option>197 - F4</option>
                <option>198 - F5</option>
                <option>199 - F6</option>
                <option>200 - F7</option>
                <option>201 - F8</option>
                <option>202 - F9</option>
                <option>203 - F10</option>
                <option>204 - F11</option>
                <option>205 - F12</option>
              </select>`
            );
          }

          html_tablerow = html_tablerow.replace("<CMNDID>", commandid);
          $("#programList").append(html_tablerow);

          return true;
        }
      </script>

      <style>
        #buttonSelectList .btn {
          height: 8rem;
        }
      </style>
    </main>

    <!-- You can also require other files to run in this process -->
    <script src="../renderer.js"></script>
  </body>
</html>
