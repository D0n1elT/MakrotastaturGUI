<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline'; script-src * 'self' 'unsafe-inline'">
    <meta http-equiv="X-Content-Security-Policy" content="default-src * 'self' 'unsafe-inline'; script-src * 'self' 'unsafe-inline'">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Makrotastatur Programmier-GUI</title>

    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <!--<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>-->

    <link rel="stylesheet" href="btn-arrows.css">
  </head>

  <body>
    <main class="main pt-2 px-1 m-0 mb-2 p-md-3 m-md-3">
      <button class="float-left btn-arrow-left mx-3 btn btn-dark" onclick="history.back()">Zur√ºck</button>
      <h3 id="titleText" class="text-right">Makrotastatur - Taster bearbeiten</h3>
      <hr></hr>

      <form id="programForm" action="#">
        <table id="programList" class='w-100 text-center'>
          <tr>
            <th style="border-bottom: 1px solid gray; border-right: 1px solid gray; width: 20%">
              Befehl
            </th>
            <th style="border-bottom: 1px solid gray;">
              Wert
            </th>
          </tr>
        </table>
        <div id="commandNavbar" class="m-0 mt-3 btn-group fixed-bottom row w-100">
          <input  type="submit" class="btn btn-success" onclick="submitForm(null)"></input>
          <button type="button" class="btn btn-dark"    onclick="if(addCommand(1) === false)alert('Etwas ging schief.')">String</button>
          <button type="button" class="btn btn-dark"    onclick="if(addCommand(2) === false)alert('Etwas ging schief.')">Delay</button>
          <button type="button" class="btn btn-dark"    onclick="if(addCommand(3) === false)alert('Etwas ging schief.')">Mod Key Press</button>
          <button type="button" class="btn btn-dark"    onclick="if(addCommand(4) === false)alert('Etwas ging schief.')">Mod Key Release</button>
          <button type="button" class="btn btn-danger">Record</button> <!--// TODO: open modal and record key combination -->
        </div>
      </form>

      <script>
        function loadDarkMode() {
          // Get HTML head element
          var head = document.getElementsByTagName('HEAD')[0];

          // Create new link Element
          var link = document.createElement('link');

          // set the attributes for link element
          link.rel = 'stylesheet';
          link.type = 'text/css';
          link.href = '../node_modules/bootswatch/dist/darkly/bootstrap.min.css';
          // Append link element to HTML head 
          head.appendChild(link);

          $(".btn-arrow-left ").removeClass("btn-arrow-left  mx-3");
          $(".btn-arrow-right").removeClass("btn-arrow-right mx-3");

          localStorage.setItem("dark_mode_active", true);
        }

        function displayAlertMessage(title, message, color = "", openTime = "slow", closeTime = "fast") {
          var alertHTML = `
          <div id="bsAlert" class="alert `+color+` alert-dismissible" role="alert">
            <strong class="display-4">`+title+`</strong>
            <hr></hr>
            <p class="p-0 m-0" id="errorMessage">
              `+message+`
            </p>
            <button type="button" class="close" onclick="$('#bsAlert').slideUp('`+closeTime+`');" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>`;

          // Remove old instances.
          $("#bsAlert").remove();

          $("main").prepend(alertHTML);
          // Hide it immediately
          $("#bsAlert").hide();

          // Move to right location...
          $("#bsAlert").insertAfter($('#titleText + hr'));

          // Display...
          $("#bsAlert").slideDown(openTime);
        }

        window.addEventListener('DOMContentLoaded', () => {
          // IF DARK MODE ADD BOOTSWATCH CSS FILES
          console.error(localStorage.getItem("dark_mode_active") + " " + window.Bridge.checkDarkMode());
          if (window.Bridge.checkDarkMode() == true || localStorage.getItem("dark_mode_active") == "true") {
            loadDarkMode();
          }

          $('#programForm').submit(function( event ) {
            submitForm(event, this);
          });

          Sortable.create(programList, {
            animation: 200,
            draggable: 'tr',
            sort: true,
            chosenClass: 'active',
            ghostClass: "ghost",
            handle: "#commandlabel"
          });
        });

        function addCommand(commandid) {
          var html_tablerow = `
              <tr commandid="<CMNDID>" style="width: 75%; border-top: 1px solid gray;" class='p-0 pl-2 pr-2 pt-2 m-0'>
                <td id="commandlabel" class='m-0 p-0' style="border-right: 1px solid gray;">
                  <img src="imgs/movable.png" alt="::" style="max-width: 20px; filter: opacity(50%);" class="m-0 p-0 d-inline-block float-left"></img> <COMMAND>
                </td>
                <td id="value">
                  <VALUE>
                </td>
              </tr>`;

          if (commandid == 1) {
            html_tablerow = html_tablerow.replace("<COMMAND>", "String");
            html_tablerow = html_tablerow.replace("<VALUE>",
                                    `<!-- pattern='[\\w,.!?+\\-#*\\s]+' -->
                                     <input name="string" class='p-1 m-0 mt-2 mx-2 form-control d-inline-block' type='text' wrap='off' pattern='[\\w,.!?+\\-#*\\s]+' style='max-width:95%; width:95%;'></input>
                                     <p class='text-muted text-right mr-3 pb-0 mb-0' style='font-size: 80%;'>do not use special characters except punctuation marks</p>
            `);
          } else if (commandid == 2) {
            html_tablerow = html_tablerow.replace("<COMMAND>", "Delay");
            html_tablerow = html_tablerow.replace("<VALUE>",
                                    `<input name="time" class="p-1 my-3 mx-2 form-control d-inline-block" min="0" style="max-width: 95%; width: 95%;" max="65536" type="number"></input>
            `);
          } else if (commandid == 3) {
            html_tablerow = html_tablerow.replace("<COMMAND>", "Mod Key Press");
          } else if (commandid == 4) {
            html_tablerow = html_tablerow.replace("<COMMAND>", "Mod Key Release");
          } else {
            return false;
          }

          if (commandid == 3 || commandid == 4) {
            html_tablerow = html_tablerow.replace("<VALUE>",`
              <select class="form-control p-0 my-3 mx-2 d-inline-block selectList" style="max-width: 95%; width: 95%;">
                <option>128 - LEFT CTRL</option>
                <option>129 - LEFT SHIFT</option>
                <option>130 - LEFT ALT</option>
                <option>131 - LEFT GUI</option>
                <option>132 - RIGHT CTRL</option>
                <option>133 - RIGHT SHIFT</option>
                <option>134 - RIGHT ALT</option>
                <option>135 - RIGHT GUI</option>
                <option>176 - RETURN</option>
                <option>177 - ESC</option>
                <option>178 - BACKSPACE</option>
                <option>179 - TAB</option>
                <option>215 - RIGHT ARROW</option>
                <option>216 - LEFT ARROW</option>
                <option>217 - DOWN ARROW</option>
                <option>218 - UP ARROW</option>
                <option>209 - INSERT</option>
                <option>212 - DELETE</option>
                <option>211 - PAGE UP</option>
                <option>214 - PAGE DOWN</option>
                <option>210 - HOME</option>
                <option>213 - END</option>
                <option>193 - CAPS LOCK</option>
                <option>194 - F1</option>
                <option>195 - F2</option>
                <option>196 - F3</option>
                <option>197 - F4</option>
                <option>198 - F5</option>
                <option>199 - F6</option>
                <option>200 - F7</option>
                <option>201 - F8</option>
                <option>202 - F9</option>
                <option>203 - F10</option>
                <option>204 - F11</option>
                <option>205 - F12</option>
              </select>`
            );
          }

          html_tablerow = html_tablerow.replace("<CMNDID>", commandid);
          $("#programList").append(html_tablerow);

          return true;
        }
      </script>
    </main>

    <style>
      #commandNavbar .btn {
        border-radius: 0px;
      }

      #programList tr {
        margin-bottom: 2px !important;
      }

      .ghost {
        opacity: 0.4;
      }

      .active {
        border: 2px solid grey !important;
        margin-bottom: 0px !important;
      }
    </style>

    <!-- You can also require other files to run in this process -->
    <script src="../renderer.js"></script>
  </body>
</html>
