<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'">
    <meta http-equiv="X-Content-Security-Policy" content="default-src 'self'; script-src 'self'">-->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Hello World!</title>

    <!-- Bootstrap! -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!-- /bootstrap... -->

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <link rel="stylesheet" href="btn-arrows.css">
  </head>

  <body>
    <main class="main pt-2 px-1 m-0 mb-2 p-md-3 m-md-3">
      <button class="float-left btn-arrow-left mx-3 btn btn-dark" onclick="history.back()">Zur√ºck</button>
      <h3 class="text-right">Makrotastatur - Taster programmieren</h3>
      <hr></hr>

      <form id="programForm" action="#">
        <table id="programList" class='w-100 text-center'>
          <tr>
            <th style="border-bottom: 1px solid black; border-right: 1px solid black; width: 20%">
              Befehl
            </th>
            <th style="border-bottom: 1px solid black;">
              Wert
            </th>
          </tr>
        </table>
        <div id="commandNavbar" class="m-0 mt-3 btn-group fixed-bottom row w-100">
          <input  type="submit" class="btn btn-success" onclick="submitForm(null)"></input>
          <button type="button" class="btn btn-dark"    onclick="if(addCommand(1) === false)alert('Etwas ging schief.')">String</button>
          <button type="button" class="btn btn-dark"    onclick="if(addCommand(2) === false)alert('Etwas ging schief.')">Delay</button>
          <button type="button" class="btn btn-dark"    onclick="if(addCommand(3) === false)alert('Etwas ging schief.')">Mod Key Press</button>
          <button type="button" class="btn btn-dark"    onclick="if(addCommand(4) === false)alert('Etwas ging schief.')">Mod Key Release</button>
          <button type="button" class="btn btn-danger">Record</button> <!--// TODO: open modal and record key combination -->
        </div>
      </form>

      <script>
        function submitForm(event) {
          $( ".textarea-validate" ).each(function( index ) {
            console.log( index + ": " + $( this ).val() );
            validateTextarea(this);
            if (!this.validity.valid) {
              console.log("PREVENT SUBMIT");
              if (event != null) event.preventDefault();
            }
          });
        }
        $('#programForm').submit(function( event ) {
          submitForm(event, this);
        });

        Sortable.create(programList, {
          animation: 250,
          draggable: 'tr',
          sort: true,
          chosenClass: 'active',
          ghostClass: "ghost",
          handle: "#commandlabel"
        });

        function addCommand(commandid) {
          html_tablerow = `
              <tr commandid="<CMNDID>" style="width: 75%; border-top: 1px solid gray;" class='p-0 pl-2 pr-2 pt-2 m-0'>
                <td id="commandlabel" class='m-0 p-0' style="border-right: 1px solid black;">
                  <img src="imgs/movable.png" alt="::" style="max-width: 20px; filter: opacity(50%);" class="m-0 p-0 d-inline-block float-left"></img> <COMMAND>
                </td>
                <td id="value">
                  <VALUE>
                </td>
              </tr>`;

          if (commandid == 1) {
            html_tablerow = html_tablerow.replace("<COMMAND>", "String");
            html_tablerow = html_tablerow.replace("<VALUE>",
                                    `<!-- pattern='[\\w,.!?+\\-#*\\s]+' -->
                                     <input name="string" class='p-1 m-0 mt-2 mx-2 form-control d-inline-block' type='text' wrap='off' pattern='[\\w,.!?+\\-#*\\s]+' style='max-width:95%; width:95%;'></input>
                                     <p class='text-muted text-right mr-3 pb-0 mb-0' style='font-size: 80%;'>do not use special characters except punctuation marks</p>
            `);
          } else if (commandid == 2) {
            html_tablerow = html_tablerow.replace("<COMMAND>", "Delay");
            html_tablerow = html_tablerow.replace("<VALUE>",
                                    `<input name="time" class="p-1 my-3 mx-2 form-control d-inline-block" min="0" style="max-width: 95%; width: 95%;" max="65536" type="number"></input>
            `);
          } else if (commandid == 3) {
            html_tablerow = html_tablerow.replace("<COMMAND>", "Mod Key Press");
          } else if (commandid == 4) {
            html_tablerow = html_tablerow.replace("<COMMAND>", "Mod Key Release");
          } else {
            return false;
          }

          if (commandid == 3 || commandid == 4) {
            html_tablerow = html_tablerow.replace("<VALUE>",`
              <select class="form-control p-0 my-3 mx-2 d-inline-block selectList" style="max-width: 95%; width: 95%;">
                <option>128 - LEFT CTRL</option>
                <option>129 - LEFT SHIFT</option>
                <option>130 - LEFT ALT</option>
                <option>131 - LEFT GUI</option>
                <option>132 - RIGHT CTRL</option>
                <option>133 - RIGHT SHIFT</option>
                <option>134 - RIGHT ALT</option>
                <option>135 - RIGHT GUI</option>
                <option>176 - RETURN</option>
                <option>177 - ESC</option>
                <option>178 - BACKSPACE</option>
                <option>179 - TAB</option>
                <option>215 - RIGHT ARROW</option>
                <option>216 - LEFT ARROW</option>
                <option>217 - DOWN ARROW</option>
                <option>218 - UP ARROW</option>
                <option>209 - INSERT</option>
                <option>212 - DELETE</option>
                <option>211 - PAGE UP</option>
                <option>214 - PAGE DOWN</option>
                <option>210 - HOME</option>
                <option>213 - END</option>
                <option>193 - CAPS LOCK</option>
                <option>194 - F1</option>
                <option>195 - F2</option>
                <option>196 - F3</option>
                <option>197 - F4</option>
                <option>198 - F5</option>
                <option>199 - F6</option>
                <option>200 - F7</option>
                <option>201 - F8</option>
                <option>202 - F9</option>
                <option>203 - F10</option>
                <option>204 - F11</option>
                <option>205 - F12</option>
              </select>`
            );
          }

          html_tablerow = html_tablerow.replace("<CMNDID>", commandid);
          $("#programList").append(html_tablerow);

          return true;
        }

        /*function validateTextarea(element) {
          var textarea = element;
          var errorMsg = "Please match the format requested.";
          var pattern = new RegExp('^' + $(textarea).attr('pattern') + '$');
          // check each line of text
          $.each($(textarea).val().split("\n"), function () {
              // check if the line matches the pattern
              var hasError = !this.match(pattern);
              if (hasError) {
                console.log("Fuck: " + textarea);
              }
              if (typeof textarea.setCustomValidity === 'function') {
                  textarea.setCustomValidity(hasError ? errorMsg : '');
              } else {
                  // Not supported by the browser, fallback to manual error display...
                  $(textarea).toggleClass('error', !!hasError);
                  $(textarea).toggleClass('ok', !hasError);
                  if (hasError) {
                      $(textarea).attr('title', errorMsg);
                  } else {
                      $(textarea).removeAttr('title');
                  }
              }
              return !hasError;
          });
        }*/
      </script>
    </main>

    <style>
      #commandNavbar .btn {
        border-radius: 0px;
      }

      #programList tr {
        margin-bottom: 2px !important;
      }

      .ghost {
        opacity: 0.4;
      }

      .active {
        border: 2px solid grey !important;
        margin-bottom: 0px !important;
      }
    </style>

    <!-- You can also require other files to run in this process -->
    <script src="../renderer.js"></script>
  </body>
</html>
